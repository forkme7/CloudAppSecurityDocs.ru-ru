---
title: Интеграция Cloud App Security с внешней системой защиты от потери данных по защищенному протоколу ICAP | Документы Майкрософт
description: В этом разделе описываются действия по настройке подключения ICAP в Cloud App Security, а также установке stunnel.
keywords: ''
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 1/21/2018
ms.topic: article
ms.prod: ''
ms.service: cloud-app-security
ms.technology: ''
ms.assetid: 9656f6c6-7dd4-4c4c-a0eb-f22afce78071
ms.reviewer: reutam
ms.suite: ems
ms.openlocfilehash: 2e27bc333a5fa193c42d6e61fd6517cdfbdcf1f2
ms.sourcegitcommit: d9b65152d06b9924231b296ffe565689b44ab93e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="external-dlp-integration"></a>Интеграция с внешней системой защиты от потери данных

Cloud App Security можно интегрировать с существующими решениями для защиты от потери данных (DLP), чтобы перенести их возможности на облачную среду, применяя в то же время единообразную и согласованную политику как в локальной среде, так и в облаке. Платформа позволяет экспортировать простые в использовании интерфейсы, включая REST API и ICAP, что обеспечивает интеграцию с системами классификации содержимого, такими как Symantec Data Loss Prevention (прежнее название — Vontu Data Loss Prevention) и Forcepoint DLP. 

Интеграция осуществляется с помощью стандартного протокола ICAP и протокола наподобие HTTP, который описывается в документе [RFC 3507](https://tools.ietf.org/html/rfc3507). Чтобы защитить данные, передаваемые по протоколу ICAP, необходимо настроить защищенный туннель SSL (stunnel) между решением для защиты от потери данных и Cloud App Security. Этот туннель обеспечивает шифрование TLS для данных, передаваемых между сервером DLP и Cloud App Security. 

В этом руководстве описываются действия по настройке подключения ICAP в Cloud App Security, а также настройке stunnel для защиты данных, передаваемых по этому подключению.

> [!NOTE]
>Этот компонент доступен в виде общедоступной предварительной версии.

## <a name="architecture"></a>Архитектура
Cloud App Security сканирует облачную среду и в соответствии с конфигурацией политики файлов определяет, следует ли проверять файл с помощью внутренней или внешней системы защиты от потери данных. Если применяется внешняя система защиты от потери данных, файл пересылается через защищенный туннель в среду клиента, где он ретранслируется в устройство ICAP для вынесения решения: разрешить или заблокировать. Ответы отправляются обратно в Cloud App Security через защищенный туннель (stunnel). На основе ответов политика определяет последующие действия, такие как выдача предупреждения, помещение в карантин или предоставление управления.

![Архитектура stunnel](./media/icap-architecture-stunnel.png)

Так как Cloud App Security работает в Azure, развертывание в Azure обеспечивает более высокую производительность. Но поддерживаются и иные варианты развертывания, в том числе в других облачных средах и в локальной среде. Развертывание в других средах может приводить к снижению производительности из-за более длительной задержки и меньшей пропускной способности. Для шифрования трафика сервер ICAP и stunnel необходимо развертывать в одной сети.

## <a name="prerequisites"></a>Предварительные условия
Чтобы компонент Cloud App Security мог отправлять данные через защищенный туннель на сервер ICAP, откройте в брандмауэре сети периметра внешние IP-адреса, используемые Cloud App Security с номером динамического исходного порта. 

1.  Исходные адреса: см. [подраздел "Предварительные условия" раздела "Подключение приложений"](enable-instant-visibility-protection-and-governance-actions-for-your-apps.md#prerequisites)
2.  Исходный TCP-порт: динамический
3.  Адреса назначения: один или два IP-адреса сервера stunnel, подключенного к внешнему серверу ICAP, который вы настроите далее
4.  TCP-порт назначения: как определено в сети

> [!NOTE] 
> По умолчанию порт stunnel имеет номер 11344. При необходимости его можно изменить, но при этом необходимо записать новый номер порта, так как его потребуется ввести в следующем шаге.

## <a name="step-1--set-up-icap-server"></a>Шаг 1. Настройка сервера ICAP

Настройте сервер ICAP, записав номер порта и задав для параметра **Режим** значение **Блокировка**. В режиме блокировки сервер ICAP ретранслирует решение о классификации обратно в Cloud App Security.

Инструкции по выполнению этого действия см. в документации к вашему внешнему решению для защиты от потери данных. В качестве примера см. [установки server приложение A: Forcepoint ICAP](#forcepoint) и [руководство по развертыванию приложение б: Symantec](#symantec).

## <a name="step-2--set-up-your-stunnel-server"></a>Шаг 2. Настройка сервера stunnel 

На этом этапе вы должны настроить сервер stunnel, подключенный к серверу ICAP. 

>[!NOTE]
> Хотя это действие настоятельно рекомендуется к выполнению, оно необязательно и в тестовых развертываниях его можно пропустить. 

### <a name="install-stunnel-on-a-server"></a>Установка stunnel на сервере

**Предварительные требования**

- **Сервер** — сервер Windows Server или Linux (один из основных дистрибутивов).

Сведения о типах серверов, которые поддерживают установку stunnel, см. на [веб-сайте stunnel](https://www.stunnel.org/index.html). В случае с Linux для установки можно использовать диспетчер распространения Linux.

#### <a name="install-stunnel-on-windows"></a>Установка stunnel в Windows

1. [Скачайте последнюю версию Windows Server](https://www.stunnel.org/downloads.html) (должен подойти любой из последних выпусков Windows Server).
   (установка по умолчанию)

2. В ходе установки не создавайте самозаверяющий сертификат. Он будет создан позже.

3. Установите флажок **Запустить сервер после установки**.

4. Создайте сертификат одним из указанных ниже способов.

   - Используйте сервер управления сертификатами для создания SSL-сертификата на сервере ICAP, а затем скопируйте ключи на сервер, подготовленный для установки stunnel.
   - Либо создайте закрытый ключ и самозаверяющий сертификат на сервере stunnel с помощью приведенных ниже команд OpenSSL. Замените следующие переменные:
     -    **key.pem** на имя закрытого ключа;
     -    **cert.pem** на имя сертификата;
     -    **stunnel-key** на имя нового ключа.

5. Откройте каталог config по пути установки stunnel. По умолчанию это путь c:\Program Files (x86)\stunnel\config\
6. Запустите командную строку с разрешениями администратора и выполните следующие команды: `..\bin\openssl.exe genrsa -out key.pem 2048 `.
      
     ` ..\bin\openssl.exe  req -new -x509 -config ".\openssl.cnf" -key key.pem -out .\cert.pem -days 1095`

7. Объедините cert.pem и key.pem и сохраните их в следующем файле: `type cert.pem key.pem >> stunnel-key.pem`.

8. [Скачайте открытый ключ](https://adaprodconsole.blob.core.windows.net/icap/publicCert.pem) и сохраните его в следующем расположении: **C:\Program Files (x86)\stunnel\config\MCASca.pem**.

9. Чтобы открыть порт в брандмауэре Windows, добавьте следующие правила.

       rem Open TCP Port 11344 inbound and outbound
       netsh advfirewall firewall add rule name="Secure ICAP TCP Port 11344" dir=in action=allow protocol=TCP localport=11344
       netsh advfirewall firewall add rule name="Secure ICAP TCP Port 11344" dir=out action=allow protocol=TCP localport=11344

10. Запустите файл `c:\Program Files (x86)\stunnel\bin\stunnel.exe`, чтобы открыть приложение stunnel. 

11. Откройте меню **Configuration** (Настройка) и выберите пункт **Edit configuration** (Изменить конфигурацию).

    ![Изменение конфигурации Windows Server](./media/stunnel-windows.png)
 
12. Откройте файл и вставьте приведенные ниже строки конфигурации сервера, где **DLP Server IP** — это IP-адрес сервера ICAP, **stunnel-key** — ключ, созданный на предыдущем шаге, а **MCASCAfile** — общедоступный сертификат клиента stunnel в Cloud App Security. Кроме того, удалите весь текст, приведенный для образца (в примере это текст Gmail), а затем скопируйте в файл следующие строки:

        [microsoft-Cloud App Security]
        accept = 0.0.0.0:11344
        connect = **ICAP Server IP**:1344
        cert = C:\Program Files (x86)\stunnel\config\**stunnel-key**.pem
        CAfile = C:\Program Files (x86)\stunnel\config\**MCASCAfile**.pem
        TIMEOUTclose = 0
        client = no
13. Сохраните файл и выберите команду **Reload configuration** (Перезагрузить конфигурацию).

14. Чтобы проверить, все ли работает правильно, в командной строке выполните следующую команду: `netstat -nao  | findstr 11344`.
 

#### <a name="install-stunnel-on-ubuntu"></a>Установка stunnel в Ubuntu

В следующем примере рассматривается установка на сервере Ubuntu с правами привилегированного пользователя. В случае с другими серверами используйте параллельные команды. 

На подготовленном сервере Ubuntu скачайте и установите последнюю версию stunnel, выполнив следующую команду (которая также установит OpenSSL).

    apt-get update
    apt-get install openssl -y
    apt-get install stunnel4 -y
Проверьте, установлен ли stunnel, выполнив в консоли приведенную ниже команду. Должен быть выведен номер версии и список параметров конфигурации.

    stunnel-version

### <a name="generate-certificates"></a>Создание сертификатов

Сервер ICAP и компонент Cloud App Security используют закрытый ключ и открытый сертификат для проверки подлинности сервера и шифрования данных, передаваемых через туннель stunnel. Чтобы ПО stunnel могло работать как фоновая служба, закрытый ключ следует создавать без парольной фразы. Кроме того, назначьте файлам разрешение на **чтение** для владельца stunnel и **нет** для всех остальных пользователей.

Создать сертификаты можно одним из указанных ниже способов.
-   Используйте сервер управления сертификатами для создания SSL-сертификата на сервере ICAP, а затем скопируйте ключи на сервер, подготовленный для установки stunnel. 
-   Либо создайте закрытый ключ и самозаверяющий сертификат на сервере stunnel с помощью приведенных ниже команд OpenSSL. Замените следующие переменные:
    - **key.pem** на имя закрытого ключа;
    - **cert.pem** на имя сертификата;
    - **stunnel-key** на имя нового ключа.
       
            openssl genrsa -out key.pem 2048
            openssl req -new -x509 -key key.pem -out cert.pem -days 1095
            cat key.pem cert.pem >> /etc/ssl/private/stunnel-key.pem

### <a name="download-the-cloud-app-security-stunnel-client-public-key"></a>Скачивание открытого ключа клиента stunnel Cloud App Security

Скачайте открытый ключ отсюда: https://adaprodconsole.blob.core.windows.net/icap/publicCert.pem. Сохраните его здесь: **/etc/ssl/certs/MCASCAfile.pem**

### <a name="configure-stunnel"></a>Настройка stunnel 

Конфигурация stunnel задается в файле stunnel.conf.

1. Создайте файл stunnel.conf в следующем каталоге: **vim /etc/stunnel/stunnel.conf**.

3.  Откройте файл и вставьте приведенные ниже строки конфигурации сервера, где **DLP Server IP** — это IP-адрес сервера ICAP, **stunnel-key** — ключ, созданный на предыдущем шаге, а **MCASCAfile** — общедоступный сертификат клиента stunnel в Cloud App Security.

        [microsoft-Cloud App Security]
        accept = 0.0.0.0:11344
        connect = **ICAP Server IP**:1344
        cert = /etc/ssl/private/**stunnel-key**.pem
        CAfile = /etc/ssl/certs/**MCASCAfile**.pem
        TIMEOUTclose = 1
        client = no


### <a name="update-your-ip-table"></a>Изменение таблицы IP-адресов
Измените таблицу IP-адресов, добавив следующее правило маршрутизации:
   
    iptables -I INPUT -p tcp --dport 11344 -j ACCEPT

Чтобы сохранить изменения, внесенные в таблицу IP-адресов, используйте следующие команды:

     sudo apt-get install iptables-persistent
     sudo /sbin/iptables-save > /etc/iptables/rules.v4
 

### <a name="run-stunnel"></a>Запуск stunnel
1.  На сервере stunnel выполните следующую команду:

        vim /etc/default/stunnel4

2.  Измените значение переменной ENABLED на 1:

        ENABLED=1

3.  Перезапустите службу, чтобы конфигурация вступила в силу.

        /etc/init.d/stunnel4 restart

4.  Выполните следующие команды, чтобы проверить, правильно ли работает ПО stunnel:

        ps -A | grep stunnel

    и прослушивает ли оно указанный порт:

        netstat -anp | grep 11344

5. Убедитесь в том, что сеть, в которой развернут сервер stunnel, отвечает описанным выше предварительным требованиям. Это необходимо для успешного установления входящих подключений из Cloud App Security к серверу.

Если процесс не выполняется, см. сведения об устранении неполадок в [документации stunnel](https://www.stunnel.org/docs.html).


## <a name="step-3--connect-to-cloud-app-security"></a>Шаг 3. Подключение к Cloud App Security

1. В Cloud App Security в области **Параметры** выберите **Расширения безопасности** и перейдите на вкладку **Внешняя защита от потери данных**.

2. Щелкните знак "плюс", чтобы добавить новое подключение. 

3. В мастере **добавления новой внешней системы защиты от потери данных** укажите **имя подключения** (например "Соединитель Forcepoint"), которое будет использоваться для определения соединителя.

4. Выберите **тип подключения**:
    - **Symantec Vontu** — выберите этот вариант для настраиваемой интеграции с устройствами Vontu DLP;
    - **Forcepoint DLP** — выберите этот вариант для настраиваемой интеграции с устройствами Forcepoint DLP;
    - **Универсальный ICAP — REQMOD** — для других устройств DLP, использующих [изменение запросов](https://tools.ietf.org/html/rfc3507);
    - **Универсальный ICAP — RESPMOD** — для других устройств DLP, использующих [изменение ответов.](https://tools.ietf.org/html/rfc3507)
    ![Подключение ICAP к Cloud App Security](./media/icap-wizard1.png)

5. Выберите общедоступный сертификат (cert.pem), созданный на предыдущих шагах, чтобы подключиться к stunnel, и нажмите кнопку **Далее**.

   > [!NOTE]
   > Настоятельно рекомендуется установить флажок **Использовать защищенный ICAP**, чтобы настроить зашифрованный шлюз stunnel. Если вы проводите тестирование или у вас нет сервера stunnel, можно снять этот флажок, чтобы выполнить интеграцию с сервером DLP напрямую. 

5. На экране **Конфигурация сервера** укажите **IP-адрес** и **порт** сервера stunnel, настроенные в шаге 2. Для балансировки нагрузки вы можете указать **IP-адрес** и **Порт** дополнительного сервера. Указанные IP-адреса должны быть внешними статическими IP-адресами ваших серверов.

   ![Подключение ICAP к Cloud App Security](./media/icap-wizard2.png)
6. Нажмите кнопку **Далее**. Cloud App Security проверит подключение к настроенному серверу. Если возникает ошибка, изучите инструкции и проверьте параметры сети. После успешного подключения можно нажать кнопку **Выход**.

7. Чтобы направить трафик на этот внешний сервер защиты от потери данных, при создании **политики файлов** в поле **Метод проверки содержимого** выберите созданное подключение. Дополнительные сведения о [создании политики файлов](data-protection-policies.md).


## Приложение А. Настройка сервера ICAP Forcepoint<a name="forcepoint"></a>

В ForcePoint настройте устройство, выполнив указанные ниже действия.

1.  В устройстве DLP выберите **Deployment** (Развертывание) > **System Modules** (Системные модули). 

    ![Развертывание ICAP](./media/icap-system-modules.png)

2.  На вкладке **General** (Общие) для параметра **ICAP Server** (Сервер ICAP) необходимо выбрать значение **Enabled** (Включен), а для **порта** по умолчанию — задать номер **1344**. Кроме того, в поле **Allow connection to this ICAP Server from the following IP addresses** (Разрешить подключение к этому серверу ICAP со следующих IP-адресов) выберите значение **Any IP address** (Любой IP-адрес).
 
    ![Конфигурация ICAP](./media/icap-ip-address.png)

3.  На вкладке "HTTP/HTTPS" выберите для параметра **Mode** (Режим) значение **Blocking** (Блокировка).
 
    ![Блокировка ICAP](./media/icap-blocking.png)
 

## Приложение Б., "Руководство по развертыванию Symantec" <a name="symantec"></a>

Поддерживается решение Symantec DLP версии 11 и новее. 

Как указано выше, сервер обнаружения нужно развернуть в том же центре обработки данных Azure, что и клиент Cloud App Security. Сервер обнаружения синхронизируется с сервером принудительной защиты через выделенный туннель IPSec. 
 
### <a name="detection-server-installation"></a>Установка сервера обнаружения 
Сервер обнаружения, используемый Cloud App Security, представляет собой стандартный сервер с поддержкой модуля Network Prevent for Web. Вам потребуется изменить несколько параметров настройки.
1. Отключите **режим пробной версии**.
   1. Последовательно выберите **System** > **Servers and Detectors** (Система > Серверы и детекторы) и щелкните целевой объект ICAP. 
    
      ![Целевой объект ICAP](./media/icap-target.png)
    
   2. Щелкните **Настройка**. 
    
      ![Настройка целевого объекта ICAP](./media/configure-icap-target.png)
    
   3. Отключите **режим пробной версии**.
    
      ![Отключение режима пробной версии](./media/icap-disable-trial-mode.png)
    
2. Последовательно выберите **ICAP** > **Response Filtering** (Фильтрация откликов) и установите для параметра **Ignore Responses Smaller Than** (Игнорировать отклики объемом менее) значение 1.


3. Также добавьте строку "application/<em>" в список **Inspect Content Type</em>** (Проверять тип содержимого).
     ![Проверка типа содержимого](./media/icap-inspect-content-type.png)

4. Нажмите кнопку **Сохранить**.


### <a name="policy-configuration"></a>Настройка политики
Cloud App Security свободно поддерживает все типы правил обнаружения, включенные в решение Symantec для защиты от потери данных, поэтому нет необходимости изменять существующие правила. Тем не менее, чтобы обеспечить полную интеграцию, необходимо применить некоторые изменения конфигурации ко всем существующим и новым политикам. Это изменение представляет собой дополнение к определенным правилам отклика для всех политик. 

Добавьте в Vontu изменение конфигурации.

1.  Последовательно выберите **Manage** > **Policies** > **Response Rules** (Управление > Политики > Правила отклика) и щелкните **Add Response Rule** (Добавить правило отклика).
    
    ![Добавление правила отклика](./media/icap-add-response-rule.png)

2.  Установите переключатель **Automated Response** (Автоматический отклик) и нажмите кнопку **Next** (Далее).

    ![Автоматический отклик](./media/icap-automated-response.png)

3. Введите имя правила, например **Блокировка HTTP/HTTPS**. В разделе **Действия** выберите **Блокировка HTTP/HTTPS** и щелкните **Сохранить**.

    ![Блокировка HTTP](./media/icap-block-http.png)

Добавьте созданное правило во все существующие политики.

1. В каждой политике перейдите на вкладку **Response** (Отклик).

2. В раскрывающемся списке **Правило отклика** выберите созданное ранее правило отклика для блокировки.

3. Сохраните политику.
   
    ![Отключение режима пробной версии](./media/icap-add-policy.png)

Это правило необходимо добавить во все существующие политики.

>[!NOTE]
> Если вы используете Symantec Vontu для проверки файлов из Dropbox, CAS автоматически укажет в качестве источника файла следующий URL-адрес: http://misc/filename. Этот замещающий URL-адрес никуда не ведет, но используется для журналов.


## <a name="see-also"></a>См. также  
[Управление облачными приложениями с помощью политик](control-cloud-apps-with-policies.md)   

[Клиенты с поддержкой Premier также могут выбрать Cloud App Security непосредственно на портале Premier.](https://premier.microsoft.com/)  
