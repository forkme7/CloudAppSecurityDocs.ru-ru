---
title: "Настройка автоматической отправки журналов для непрерывных отчетов | Документы Майкрософт"
description: "Из этой статьи вы узнаете, как настроить автоматическую отправку журналов для непрерывных отчетов в Cloud App Security, используя Docker в среде Ubuntu, развернутой в Azure."
keywords: 
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 1/15/2018
ms.topic: get-started-article
ms.prod: 
ms.service: cloud-app-security
ms.technology: 
ms.assetid: 9c51b888-54c0-4132-9c00-a929e42e7792
ms.reviewer: reutam
ms.suite: ems
ms.openlocfilehash: 03ace8d5bf61ed623ad90b3717c4d35b767498a3
ms.sourcegitcommit: 458e936e1ac548eda37e9bf955b439199bbdd018
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2018
---
# <a name="set-up-and-configuration-on-ubuntu"></a>Установка и настройка в Ubuntu


## <a name="technical-requirements"></a>Технические требования

-   ОС: Ubuntu 14.04 или более поздние версии (стабильная версия Docker с поддержкой Ubuntu 17.10 недоступна)

-   Место на диске: 250 ГБ

-   ЦП: 2

-   ОЗУ: 4 ГБ

-   Настройте брандмауэр, как описано в перечне [требований к сети](network-requirements#log-collector)

## <a name="log-collector-performance"></a>Производительность сборщика журналируемых данных

Сборщик журналируемых данных может успешно обрабатывать до 50 ГБ журналов в час. Основными узкими местами в процессе сбора журналов являются:

-   Пропускная способность сети — определяет скорость отправки журналов.

-   Производительность ввода-вывода виртуальной машины, назначенная ИТ-специалистом, — определяет скорость записи журналов на диск сборщика. Сборщик журналируемых данных снабжен встроенным защитным механизмом, который контролирует скорость поступления журналов и сравнивает ее со скоростью передачи. В случае перегрузки сборщик начинает удалять файлы журнала. Если нагрузка обычно превышает 50 ГБ в час, рекомендуется разделить трафик между несколькими сборщиками журналируемых данных.

## <a name="set-up-and-configuration"></a>Настройка и конфигурация  

### <a name="step-1--web-portal-configuration-define-data-sources-and-link-them-to-a-log-collector"></a>Шаг 1. Конфигурация веб-портала: определение источников данных и связывание их со сборщиком журналируемых данных

1.  Перейдите на страницу настройки автоматической отправки:  <br></br>На портале Cloud App Security щелкните значок настроек ![значок настроек](./media/settings-icon.png), а затем выберите пункт **Сборщики данных журнала**.

2.  Для каждого брандмауэра или прокси-сервера, с которого вы хотите отправить журналы, создайте соответствующий источник данных:

    ![ubuntu1](./media/ubuntu1.png)

    a. Щелкните **Добавление источника данных**.

    b. Присвойте **Имя** прокси-серверу или брандмауэру.

    c. Выберите устройство в списке **Источник**. Если вы выбрали **пользовательский формат журнала** для работы с сетевым устройством, которое не указано в списке, см. инструкции по настройке из статьи [Использование настраиваемого средства синтаксического анализа журналов](custom-log-parser.md).

    d. Сравните журнал с примером ожидаемого формата журнала. Если формат вашего файла журнала не соответствует этому примеру, необходимо добавить источник данных с параметром **Другой**.

    e. Задайте для параметра **Тип приемника** значение **FTP**, **FTPS**, **Syslog — UDP**, **Syslog — TCP** или **Syslog — TLS**.
    >[!NOTE]
    >Для интеграции с протоколами безопасной передачи (FTPS и Syslog — TLS) часто требуются дополнительные параметры, брандмауэр или прокси-сервер.

    f. Повторите эту процедуру для каждого брандмауэра и прокси-сервера, журналы которых можно использовать для обнаружения трафика в сети.

3.  Перейдите на расположенную сверху вкладку **Сборщики данных журнала**.

    a. Щелкните **Добавить сборщик данных журнала**.

    b. Присвойте **имя** сборщику журналируемых данных.

    c. Введите **IP-адрес узла** компьютера, который будет использоваться для развертывания Docker. 

     > [!NOTE]
     > IP-адрес узла можно заменить именем компьютера, если имеется DNS-сервер (или его аналог), способный разрешить это имя узла.

    d. Выберите все **источники данных**, которые необходимо подключить к сборщику, и нажмите кнопку **Обновить**, чтобы сохранить конфигурацию (см. следующие шаги по развертыванию).

    ![ubuntu2](./media/ubuntu2.png)

    >  [!NOTE]
    > - Отдельный сборщик журналируемых данных может обрабатывать несколько источников данных.
    >- Скопируйте содержимое экрана, так как эта информация потребуется при настройке взаимодействия сборщика журналируемых данных с Cloud App Security. Если вы выбрали системный журнал, эта информация будет включать сведения о порте, на котором будет работать прослушиватель системного журнала.

4.  Отобразятся дополнительные сведения о развертывании. **Скопируйте** команду выполнения из диалогового окна. Вы можете использовать значок копирования в буфер обмена ![значок копирования в буфер обмена](./media/copy-icon.png).

6.  **Экспортируйте** ожидаемую конфигурацию источника данных. В этой конфигурации описано, как необходимо настроить экспорт журналов на устройствах.

   ![Создание сборщика журналируемых данных](./media/windows7.png)

### <a name="step-2--deployment-of-your-machine-in-azure"></a>Шаг 2. Развертывание виртуальной машины в Azure

> [!NOTE]
> Ниже описывается развертывание в Ubuntu. Действия по развертыванию на других платформах немного отличаются.


1.  Создайте новую виртуальную машину под управлением Ubuntu в среде Azure. 
2.  Настроив виртуальную машину, откройте на ней порты.
    1.  В представлении виртуальной машины щелкните **Сеть** и выберите соответствующий интерфейс, дважды щелкнув его.
    2.  Щелкните **Группа безопасности сети** и выберите соответствующую группу безопасности.
    3.  Откройте меню **Правила безопасности для входящего трафика** и нажмите кнопку **Добавить**.
      
      ![Ubuntu в Azure](./media/ubuntu-azure.png)
    
    4. Добавьте следующие правила (в режиме **Расширенный**):

    |Название|Диапазоны конечных портов|Протокол|Источник|Destination|
    |----|----|----|----|----|
    |caslogcollector_ftp|21|TCP|<Подсеть с IP-адресом вашего устройства>|Любые|
    |caslogcollector_ftp_passive|20 000–20 099|TCP|<Подсеть с IP-адресом вашего устройства>|Любые|
    |caslogcollector_syslogs_tcp|601–700|TCP|<Подсеть с IP-адресом вашего устройства>|Любые|
    |caslogcollector_syslogs_udp|514–600|UDP|<Подсеть с IP-адресом вашего устройства>|Любые|
      
     ![Правила Ubuntu в Azure](./media/inbound-rule.png)

3.  На виртуальной машине щелкните **Connect** (Подключиться), чтобы открыть терминал.

4.  Переключитесь на привилегированного пользователя с помощью команды `sudo -i`.

5.  Если вы принимаете [условия лицензии](https://go.microsoft.com/fwlink/?linkid=862492), удалите старые версии и установите Docker CE, выполнив следующую команду:
        
        curl -o /tmp/MCASInstallDocker.sh https://adaprodconsole.blob.core.windows.net/public-files/MCASInstallDocker.sh && chmod +x /tmp/MCASInstallDocker.sh; /tmp/MCASInstallDocker.sh

      ![Команда Ubuntu в Azure](./media/ubuntu-azure-command.png)

6. На портале Cloud App Security в окне **Create new log collector** (Создать новый сборщик журналируемых данных) скопируйте команду, которая импортирует конфигурацию сборщика на хост-компьютер.

      ![Ubuntu в Azure](./media/windows7.png)

7. Выполните команду, чтобы развернуть сборщик журналируемых данных.
     
        (echo db3a7c73eb7e91a0db53566c50bab7ed3a755607d90bb348c875825a7d1b2fce) | docker run --name MyLogCollector -p 21:21 -p 20000-20099:20000-20099 -e "PUBLICIP='192.168.1.1'" -e "PROXY=192.168.10.1:8080" -e "CONSOLE=mod244533.us.portal.cloudappsecurity.com" -e "COLLECTOR=MyLogCollector" --security-opt apparmor:unconfined --cap-add=SYS_ADMIN --restart unless-stopped -a stdin -i microsoft/caslogcollector starter

     ![Прокси-сервер Ubuntu](./media/ubuntu-proxy.png)

8. Убедитесь, что сборщик работает без ошибок, выполнив команду `Docker logs <collector_name>`. Вы должны увидеть сообщение **Finished successfully!** (Завершено успешно).

   ![ubuntu8](./media/ubuntu8.png)

### <a name="step-3---on-premises-configuration-of-your-network-appliances"></a>Шаг 3. Локальная конфигурация сетевых устройств

Настройте сетевые брандмауэры и прокси-серверы для периодического экспорта журналов на выделенный порт Syslog FTP-каталога согласно указаниям в диалоговом окне, например:

    BlueCoat_HQ - Destination path: \<<machine_name>>\BlueCoat_HQ\

### <a name="step-4---verify-the-successful-deployment-in-the-cloud-app-security-portal"></a>Шаг 4. Проверка успешного развертывания на портале Cloud App Security

Проверьте состояние сборщика в таблице **Сборщик журналов** и убедитесь, что оно имеет значение **Подключен**. Если установлено значение **Создан**, возможно, что подключение и анализ сборщика не завершены.

 ![ubuntu9](./media/ubuntu9.png)

Вы также можете убедиться, что журналы периодически отправляются на портал, воспользовавшись **журналом управления**.

Если возникли проблемы во время развертывания, см. статью [Устранение неполадок с Cloud Discovery](troubleshooting-cloud-discovery.md).

### <a name="optional---create-custom-continuous-reports"></a>Дополнительно — создание настраиваемых непрерывных отчетов

Убедившись, что журналы отправляются в Cloud App Security и создаются отчеты, вы можете создать настраиваемые отчеты. Вы можете создавать настраиваемые отчеты об обнаружении на основе групп пользователей Azure Active Directory. Например, если нужно просмотреть сведения об использовании облачных приложений отделом маркетинга, можно импортировать соответствующую группу с помощью функции импорта группы пользователей, а затем создать для нее пользовательский отчет. Можно также настроить отчет на основе тега IP-адреса или диапазонов IP-адресов.

1. На портале Cloud App Security щелкните значок шестеренки "Параметры", выберите **Параметры Cloud Discovery** и затем **Управление непрерывными отчетами**. 
2. Нажмите кнопку **Создать отчет** и заполните поля.
3. В разделе **Фильтры** можно выполнить фильтрацию по источнику данных, [импортированной группе пользователей](user-groups.md) либо [тегам и диапазонам IP-адресов](ip-tags.md). 

![Настраиваемый непрерывный отчет](./media/custom-continuous-report.png)

## <a name="see-also"></a>См. также
[Устранение неполадок при развертывании Docker для Cloud Discovery](troubleshoot-docker.md)

[Клиенты с поддержкой Premier также могут выбрать Cloud App Security непосредственно на портале Premier.](https://premier.microsoft.com/)

