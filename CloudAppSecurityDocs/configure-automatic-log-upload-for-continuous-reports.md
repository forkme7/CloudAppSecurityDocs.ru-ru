---
title: "Настройка автоматической отправки журналов для обеспечения непрерывной отчетности в Cloud App Security | Microsoft Docs"
description: "В этом разделе приводятся сведения об отправке журналов для создания автоматических отчетов Cloud Discovery."
keywords: 
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 12/11/2017
ms.topic: article
ms.prod: 
ms.service: cloud-app-security
ms.technology: 
ms.assetid: c4123272-4111-4445-b6bd-2a1efd3e0c5c
ms.reviewer: reutam
ms.suite: ems
ms.openlocfilehash: c5c8f7a8a6203f23be30ea160d8867163d8f360b
ms.sourcegitcommit: 4d84f9d15256b05c785a1886338651b86622070c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/22/2017
---
# <a name="configure-automatic-log-upload-for-continuous-reports-on-a-virtual-appliance"></a>Настройка автоматической отправки журналов для непрерывных отчетов в виртуальном устройстве

> [!WARNING] 
> Для более гибкого развертывания настоятельно рекомендуется настроить отправку журналов с использованием [Docker](discovery-docker.md).

## <a name="technical-requirements"></a>Технические требования
- Низкоуровневая оболочка: HyperV или VMware
- Место на диске: 250 ГБ
- ЦП: 2
- ОЗУ: 4 ГБ 
- Настройте брандмауэр, как описано в перечне [требований к сети](network-requirements#log-collector)


## <a name="log-collector-performance"></a>Производительность сборщика журналируемых данных
Сборщик журналируемых данных может успешно обрабатывать до 50 ГБ журналов в час.
Основными узкими местами в процессе сбора журналов являются:
- Пропускная способность сети — определяет скорость отправки журналов.
- Производительность ввода-вывода виртуальной машины, назначенная ИТ-специалистом, — определяет скорость записи журналов на диск сборщика.
Сборщик журналируемых данных снабжен встроенным защитным механизмом, который контролирует скорость поступления журналов и сравнивает ее со скоростью передачи. В случае перегрузки сборщик начинает удалять файлы журнала. Если нагрузка, как обычно, превышает 50 ГБ в час, рекомендуется разделить трафик между несколькими сборщиками журналируемых данных.

## <a name="set-up-and-configuration"></a>Настройка и конфигурация  
  
### <a name="step-1--web-portal-configuration-define-data-sources-and-link-them-to-a-log-collector"></a>Шаг 1. Конфигурация веб-портала: определение источников данных и связывание их со сборщиком журналируемых данных  
  
1.  Перейдите на страницу настройки автоматической отправки:  
    На портале Cloud App Security щелкните значок настроек ![значок настроек](./media/settings-icon.png "settings icon"), а затем выберите **Сборщики журналов**.  
  
3.  Для каждого брандмауэра или прокси-сервера, с которого вы хотите отправить журналы, создайте соответствующий источник данных:  
  
    a.  Щелкните **Добавление источника данных**.  
  
    b.  Присвойте **Имя** прокси-серверу или брандмауэру.  
  
    c.  Выберите устройство в списке **Источник**. Если вы выбрали **пользовательский формат журнала** для работы с сетевым устройством, которое не указано в списке, см. инструкции по [использованию настраиваемого средства синтаксического анализа журналов](custom-log-parser.md).
  
    d.  Сравните журнал с примером ожидаемого формата журнала. Если формат вашего файла журнала не соответствует этому примеру, необходимо добавить источник данных с параметром **Другой**.  
  
    e.  Задайте для параметра **Тип приемника** значение **FTP** или **Syslog**. Для **Syslog** выберите **UDP** или **TCP**.  
  
    f.  Повторите эту процедуру для каждого брандмауэра и прокси-сервера, журналы которых можно использовать для обнаружения трафика в сети.  
  
4.  Перейдите на расположенную сверху вкладку **Сборщики данных журнала**.  
  
    a.  Щелкните **Добавить сборщик данных журнала**.  
  
    b.  Присвойте **имя** сборщику журналируемых данных.  
  
    c.  Выберите все **источники данных**, которые необходимо подключить к сборщику, и нажмите кнопку **Обновить**, чтобы сохранить конфигурацию и создать маркер доступа.  
![источники данных обнаружения](./media/discovery-data-sources.png)
  
  > [!NOTE] 
  > - Отдельный сборщик журналируемых данных может обрабатывать несколько источников данных.
  > - Скопируйте содержимое экрана, так как эта информация будет использоваться при настройке взаимодействия сборщика журналируемых данных с Cloud App Security. Если вы выбрали системный журнал, эта информация будет включать сведения о порте, на котором будет ожидать передачи данных прослушиватель системного журнала.
4.  Если вы принимаете [условия лицензии](https://go.microsoft.com/fwlink/?linkid=862492), **скачайте** новую виртуальную машину сборщика журналируемых данных, щелкнув Hyper-V или VMWare. После этого распакуйте файл с помощью пароля, который вы получили на портале.  
  
### <a name="step-2--on-premises-deployment-of-the-virtual-machine-and-network-configuration"></a>Шаг 2. Локальное развертывание виртуальной машины и конфигурации сети   

> [!NOTE] 
> Ниже описывается развертывание в Hyper-V. Этапы развертывания для низкоуровневой оболочки виртуальной машины немного отличаются.  

1.  Откройте диспетчер Hyper-V.  
  
2.  Выберите **Создать**, **Виртуальная машина** и нажмите кнопку **Далее**.  
 ![Виртуальная машина Hyper-V обнаружения](./media/discovery-hyperv-virtual-machine.png "discovery Hyper-V virtual machine")  
  
3.  Укажите **Имя** новой виртуальной машины, например CloudAppSecurityLogCollector01.then, и нажмите кнопку **Далее**.  
  
4.  Выберите **Поколение 1** и нажмите кнопку **Далее**.  
  
5.  Измените значение **Память, выделяемая при запуске** на **4096 МБ**.  
        
6. Установите флажок **Use Dynamic Memory** (Использовать динамическую память) для этой виртуальной машины и нажмите кнопку **Далее**.  
  
7.  Если доступно, выберите сетевое **Подключение** и нажмите кнопку **Далее**.  
  
8.  Щелкните **Использовать существующий виртуальный жесткий диск** и выберите файл **VHD**, входящий в скачанный архив.  
  
9.  Нажмите кнопку **Далее**, а затем — кнопку **Готово**.  
    Виртуальная машина будет добавлена в среду Hyper-V.  
  
9. Щелкните машину в таблице **Виртуальные машины** и нажмите кнопку **Запустить**.   
  
10. Подключитесь к виртуальной машине сборщика журналируемых данных, чтобы узнать, назначен ли ей DHCP-адрес. Для этого щелкните виртуальную машину и щелкните **Подключить**. Должен появиться запрос на вход. Если вы видите IP-адрес, значит, вы можете подключиться к виртуальной машине с помощью терминала или средства SSH.  Если вы не видите IP-адрес, войдите с помощью средств подключения Hyper-V или VMWare, используя учетные данные, скопированные при создании сборщика журналируемых данных. Вы можете сменить пароль и настроить виртуальную машину с помощью конфигурации сети, выполнив приведенную ниже команду.
```
sudo network_config
```
> [!NOTE]
> Виртуальная машина предварительно настроена для получения IP-адреса от DHCP-сервера. Если необходимо настроить статический IP-адрес, шлюз по умолчанию, имя узла, DNS-серверы и NTPS, можно воспользоваться служебной программой **network_config** или внести изменения вручную.


На этом этапе сборщик журналируемых данных должен быть подключен к сети и иметь доступ к порталу Cloud App Security.  

### <a name="step-3--on-premises-configuration-of-the-log-collection"></a>Шаг 3. Локальная конфигурация коллекции журналов 
Чтобы войти в сборщик журналируемых данных в первый раз и импортировать его конфигурацию с портала, сделайте следующее. 

1.  Войдите в сборщик журналируемых данных по протоколу SSH с использованием учетных данных интерактивного администратора, полученных на портале. (Если вы входите в консоль впервые, вам нужно сменить пароль и после этого выполнить вход еще раз. Если используется сеанс терминала, возможно, его нужно будет перезапустить. )
2.  Запустите служебную программу настройки сборщика с помощью маркера доступа, который вы получили, когда создавали сборщик журналируемых данных.```sudo collector_config <access token> ```
3. Укажите домен консоли, например ```contoso.portal.cloudappsecurity.com```. Он содержится в URL-адресе, который отображается после входа на портал Cloud App Security. 

4. Введите имя сборщика журналируемых данных, который нужно настроить, например **CloudAppSecurityLogCollector01** или **NewYork** на рисунке выше.

5.  Импортируйте конфигурацию сборщика журналируемых данных с портала следующим образом:  
  
      a.  Войдите в сборщик журналируемых данных по протоколу SSH с использованием учетных данных интерактивного администратора, полученных на портале.  
  
      b.  Запустите служебную программу настройки сборщика с помощью маркера доступа, который вы получили в команде ```sudo collector_config \<access token>```.  
     
      c.  Укажите домен консоли, например ``` contoso.portal.cloudappsecurity.com ```.
  
      d. Введите имя сборщика журналируемых данных, который требуется настроить, например ``` CloudAppSecurityLogCollector01  ```.

### <a name="step-4---on-premises-configuration-of-your-network-appliances"></a>Шаг 4. Локальная конфигурация сетевых устройств

Настройте сетевые брандмауэры и прокси-серверы для периодического экспорта журналов на выделенный порт Syslog FTP-каталога согласно указаниям в диалоговом окне, например:  
  
     `London Zscaler - Destination path: 614`  
  
     BlueCoat_HQ - Destination path: \<<machine_name>>\BlueCoat_HQ\  
  
### <a name="step-5---verify-the-successful-deployment-in-the-cloud-app-security-portal"></a>Шаг 5. Проверка успешного развертывания на портале Cloud App Security

Проверьте состояние сборщика в таблице **Сборщик журналов** и убедитесь, что оно имеет значение **Подключен**. Если установлено значение **Created** (Создано), возможно, подключение и анализ сборщика журналируемых данных не завершены.

![состояние сборщика журналируемых данных](./media/log-collector-status.png)

Чтобы убедиться, что журналы периодически отправляются на портал, воспользуйтесь журналом управления.  
  
Если возникли проблемы во время развертывания, см. статью [Устранение неполадок с Cloud Discovery](troubleshooting-cloud-discovery.md).

### <a name="optional---create-custom-continuous-reports"></a>Дополнительно — создание настраиваемых непрерывных отчетов

Убедившись, что журналы отправляются в Cloud App Security и создаются отчеты, вы можете создать настраиваемые отчеты. Вы можете создавать настраиваемые отчеты об обнаружении на основе групп пользователей Azure Active Directory. Например, если нужно просмотреть сведения об использовании облачных приложений отделом маркетинга, можно импортировать соответствующую группу с помощью функции импорта группы пользователей, а затем создать для нее пользовательский отчет. Можно также настроить отчет на основе тега IP-адреса или диапазонов IP-адресов.

1. На портале Cloud App Security щелкните значок с шестеренкой (значок параметров), выберите **Cloud Discovery settings** (Параметры Cloud Discovery), а затем **Manage continuous reports** (Управление непрерывными отчетами). 
2. Нажмите кнопку **Создать отчет** и заполните поля.
3. В разделе **Фильтры** можно выполнить фильтрацию по источнику данных, [импортированной группе пользователей](user-groups.md) либо [тегам и диапазонам IP-адресов](ip-tags.md). 

> [!NOTE]
> Все пользовательские отчеты могут содержать не больше 1 ГБ несжатых данных. Если объем данных превышает 1 ГБ, в отчет экспортируется первый 1 ГБ данных.

![Настраиваемый непрерывный отчет](./media/custom-continuous-report.png)

## <a name="see-also"></a>См. также  
[Работа с данными Cloud Discovery](working-with-cloud-discovery-data.md)   
[Получить техническую поддержку можно на странице службы технической поддержки Cloud App Security.](http://support.microsoft.com/oas/default.aspx?prid=16031)   
[Клиенты с поддержкой Premier также могут выбрать Cloud App Security непосредственно на портале Premier.](https://premier.microsoft.com/)  
    
      
  